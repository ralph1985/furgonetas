---
import '../styles/global.css';
import offers from '../../data/offers.json';

const total = offers.length;

const euro = (n?: number | null) =>
  typeof n === 'number' ? n.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }) : '—';

const brandLogo = (text: string) => {
  const t = text.toLowerCase();
  if (t.includes('citro')) return '/logos/citroen.svg';
  if (t.includes('peugeot') || t.includes('rifter')) return '/logos/peugeot.svg';
  if (t.includes('opel')) return '/logos/opel.png';
  if (t.includes('toyota')) return '/logos/toyota.svg';
  return '';
};

const rows = [
  { id: 'marca', label: 'Marca/Modelo' },
  { id: 'motor', label: 'Motor / Cambio' },
  { id: 'acabat', label: 'Acabado' },
  { id: 'color', label: 'Color' },
  { id: 'kms', label: 'Kilómetros' },
  { id: 'total', label: 'Total contado' },
  { id: 'iva', label: 'IVA' },
  { id: 'pvp', label: 'PVP' },
  { id: 'descuento', label: 'Descuento' },
  { id: 'base', label: 'Base' },
  { id: 'mat', label: 'Matriculación' },
  { id: 'otros', label: 'Otros' },
  { id: 'concesionario', label: 'Concesionario' },
  { id: 'fuente', label: 'Fuente' },
  { id: 'ciudad', label: 'Ciudad' },
  { id: 'mantenimiento', label: 'Mantenimiento / revisiones' },
  { id: 'enlace', label: 'Enlace anuncio' }
];
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard ofertas | Furgoneta</title>
  </head>
  <body>
    <header>
      <div>
        <h1>Dashboard de ofertas</h1>
      </div>
    </header>
    <section class="summary">
      <div class="chip">Ofertas: {total}</div>
    </section>
    <main>
      <div class="table-wrap vertical">
        <table class="vertical-table">
          <thead>
            <tr>
              <th>Dato</th>
              {offers.map((offer) => {
                const logo = brandLogo(`${offer.modelo || ''} ${offer.concesionario || ''}`);
                return (
                  <th>
                    <div class="cell-heading">
                      {logo && <img class="logo-inline" src={logo} alt="Logo" loading="lazy" />}
                      <div>
                        <div class="strong">{offer.modelo}</div>
                        <div class="muted">{offer.fuente}</div>
                      </div>
                    </div>
                  </th>
                );
              })}
            </tr>
          </thead>
          <tbody>
            {rows.map((row) => (
              <tr>
                <th class="row-label">{row.label}</th>
                {offers.map((offer) => (
                  <td class={`cell ${row.id === 'total' ? 'price total' : row.id === 'pvp' || row.id === 'descuento' || row.id === 'base' || row.id === 'iva' || row.id === 'mat' || row.id === 'otros' ? 'price' : ''}`}>
                    {row.id === 'marca' && (
                      <div>
                        <div class="strong">{offer.modelo}</div>
                        <div class="muted">{offer.concesionario || offer.fuente}</div>
                      </div>
                    )}
                    {row.id === 'motor' && (
                      <div>
                        <div class="strong">{offer.motorizacion}</div>
                        <div class="muted">{offer.cambio}</div>
                      </div>
                    )}
                    {row.id === 'acabat' && offer.acabatetapiceria}
                    {row.id === 'color' && (
                      <div>{offer.color || '—'}</div>
                    )}
                    {row.id === 'kms' && (
                      <div>{offer.kms ?? '—'}</div>
                    )}
                    {row.id === 'total' && euro(offer.total_contado)}
                    {row.id === 'pvp' && euro(offer.pvp)}
                    {row.id === 'descuento' && euro(offer.descuento)}
                    {row.id === 'base' && euro(offer.base_imponible)}
                    {row.id === 'iva' && euro(offer.iva)}
                    {row.id === 'mat' && euro(offer.matriculacion)}
                    {row.id === 'otros' && euro(offer.otros_costes)}
                    {row.id === 'concesionario' && (
                      <div>
                        <div>{offer.concesionario || '—'}</div>
                      </div>
                    )}
                    {row.id === 'fuente' && (
                      <div>{offer.fuente || '—'}</div>
                    )}
                    {row.id === 'ciudad' && (
                      <div>
                        <div>{offer.meta?.ciudad || '—'}</div>
                      </div>
                    )}
                    {row.id === 'mantenimiento' && (
                      <div>{offer.meta?.mantenimiento || '—'}</div>
                    )}
                    {row.id === 'enlace' && (
                      <div>
                        {offer.meta?.enlace ? <a href={offer.meta.enlace} target="_blank">Ver anuncio</a> : '—'}
                      </div>
                    )}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </main>
  </body>
</html>
