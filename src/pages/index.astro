---
import '../styles/global.css';
import { getOffers } from '../lib/data';

const offers = await getOffers();
const total = offers.length;
const hiddenCount = offers.filter((o) => o.hidden).length;

const euro = (n?: number | null) =>
  typeof n === 'number' ? n.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }) : '—';

const horsepower = (offer) => {
  if (offer.potencia_cv !== null && offer.potencia_cv !== undefined) {
    return `${offer.potencia_cv} CV`;
  }
  const text = `${offer.motorizacion || ''} ${offer.caracteristicas || ''}`;
  const matchCv = text.match(/(\\d{2,3})\\s*CV/i);
  if (matchCv) return `${matchCv[1]} CV`;
  const matchNum = text.match(/(\\d{2,3})/);
  return matchNum ? `${matchNum[1]} CV` : '—';
};

const rows = [
  { id: 'fuente', label: 'Fuente' },
  { id: 'concesionario', label: 'Concesionario' },
  { id: 'marca', label: 'Marca/Modelo' },
  { id: 'motor', label: 'Motor / Cambio' },
  { id: 'potencia', label: 'Potencia (CV)' },
  { id: 'acabat', label: 'Acabado' },
  { id: 'color', label: 'Color' },
  { id: 'kms', label: 'Kilómetros' },
  { id: 'total', label: 'Total contado' },
  { id: 'iva', label: 'IVA' },
  { id: 'pvp', label: 'PVP' },
  { id: 'descuento', label: 'Descuento' },
  { id: 'base', label: 'Base' },
  { id: 'mat', label: 'Matriculación' },
  { id: 'otros', label: 'Otros' },
  { id: 'ciudad', label: 'Ciudad' },
  { id: 'mantenimiento', label: 'Mantenimiento / revisiones' },
  { id: 'enlace', label: 'Enlace anuncio' }
];
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard ofertas | Furgoneta</title>
  </head>
  <body>
    <header>
      <div>
        <h1>Dashboard de ofertas</h1>
      </div>
      <nav class="nav">
        <a href="/" class="active">Ofertas</a>
        <a href="/dealers">Concesionarios</a>
      </nav>
    </header>
    <section class="summary">
      <div class="chip">Ofertas: {total}</div>
      <div class="chip warn">Ocultas: {hiddenCount}</div>
      <button id="toggleHidden" class="chip-btn">Mostrar ocultas</button>
    </section>
    <main>
      <div class="table-wrap vertical">
        <table class="vertical-table">
          <thead>
            <tr>
              <th>Dato</th>
              {offers.map((offer) => {
                const logo = offer.brand?.logo;
                return (
                  <th data-offer-id={offer.id} class={offer.hidden ? 'hidden-offer hidden-collapse' : ''}>
                    <div class="cell-heading">
                      {logo && <img class="logo-inline" src={logo} alt="Logo" loading="lazy" />}
                      <div>
                        <div class="strong">{offer.modelo}</div>
                        <div class="muted">{offer.source?.name || ''}</div>
                      </div>
                    </div>
                  </th>
                );
              })}
            </tr>
          </thead>
          <tbody>
            {rows.map((row) => (
              <tr>
                <th class="row-label">{row.label}</th>
                {offers.map((offer) => (
                  <td data-offer-id={offer.id} class={`cell ${offer.hidden ? 'hidden-offer hidden-collapse' : ''} ${row.id === 'total' ? 'price total' : row.id === 'pvp' || row.id === 'descuento' || row.id === 'base' || row.id === 'iva' || row.id === 'mat' || row.id === 'otros' ? 'price' : ''}`}>
                    {row.id === 'marca' && (
                      <div>
                        <div class="strong">{offer.modelo}</div>
                        <div class="muted">{offer.dealer?.name || ''}</div>
                      </div>
                    )}
                    {row.id === 'motor' && (
                      <div>
                        <div class="strong">{offer.motorizacion}</div>
                        <div class="muted">{offer.cambio}</div>
                      </div>
                    )}
                    {row.id === 'potencia' && (
                      <div>{horsepower(offer)}</div>
                    )}
                    {row.id === 'acabat' && offer.acabatetapiceria}
                    {row.id === 'color' && (
                      <div>{offer.color || '—'}</div>
                    )}
                    {row.id === 'kms' && (
                      <div>{offer.kms ?? '—'}</div>
                    )}
                    {row.id === 'total' && euro(offer.total_contado)}
                    {row.id === 'pvp' && euro(offer.pvp)}
                    {row.id === 'descuento' && euro(offer.descuento)}
                    {row.id === 'base' && euro(offer.base_imponible)}
                    {row.id === 'iva' && euro(offer.iva)}
                    {row.id === 'mat' && euro(offer.matriculacion)}
                    {row.id === 'otros' && euro(offer.otros_costes)}
                    {row.id === 'concesionario' && (
                      <div>
                        <div>{offer.dealer?.name || '—'}</div>
                      </div>
                    )}
                    {row.id === 'fuente' && (
                      <div>{offer.source?.name || '—'}</div>
                    )}
                    {row.id === 'ciudad' && (
                      <div>
                        <div>{offer.dealer?.city || '—'}</div>
                      </div>
                    )}
                    {row.id === 'mantenimiento' && (
                      <div>{offer.mantenimiento || '—'}</div>
                    )}
                    {row.id === 'enlace' && (
                      <div>
                        {offer.enlace ? <a href={offer.enlace} target="_blank">Ver anuncio</a> : '—'}
                      </div>
                    )}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </main>

    <script>
      (async () => {
        const res = await fetch('/api/hidden');
        const data = await res.json().catch(() => ({ hidden: [] }));
        const hidden = new Set(data.hidden || []);
        const toggleBtn = document.getElementById('toggleHidden');
        let showHidden = false;

        const applyHidden = () => {
          document.querySelectorAll('[data-offer-id]').forEach((el) => {
            const id = el.getAttribute('data-offer-id');
            if (!id) return;
            if (hidden.has(id)) {
              el.classList.add('hidden-offer');
              el.classList.toggle('hidden-collapse', !showHidden);
            } else {
              el.classList.remove('hidden-offer', 'hidden-collapse');
            }
          });
          toggleBtn.textContent = showHidden ? 'Ocultar ocultas' : 'Mostrar ocultas';
        };

        document.querySelectorAll('th[data-offer-id]').forEach((th) => {
          const id = th.getAttribute('data-offer-id');
          if (!id) return;
          const btn = document.createElement('button');
          btn.textContent = hidden.has(id) ? 'Mostrar' : 'Ocultar';
          btn.className = 'hide-btn';
          btn.onclick = async () => {
            await fetch('/api/hidden', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ id, hidden: !hidden.has(id) })
            });
            location.reload();
          };
          th.appendChild(btn);
        });

        toggleBtn.onclick = () => {
          showHidden = !showHidden;
          applyHidden();
        };

        applyHidden();
      })();
    </script>
  </body>
</html>
