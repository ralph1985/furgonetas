---
import '../styles/global.css';
import { getOffers } from '../lib/data';

const offers = await getOffers();
const total = offers.length;
const hiddenCount = offers.filter((o) => o.hidden).length;

const euro = (n?: number | null) =>
  typeof n === 'number' ? n.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }) : 'â€”';

const horsepower = (offer) => {
  if (offer.potencia_cv !== null && offer.potencia_cv !== undefined) {
    return `${offer.potencia_cv} CV`;
  }
  const text = `${offer.motorizacion || ''} ${offer.caracteristicas || ''}`;
  const matchCv = text.match(/(\\d{2,3})\\s*CV/i);
  if (matchCv) return `${matchCv[1]} CV`;
  const matchNum = text.match(/(\\d{2,3})/);
  return matchNum ? `${matchNum[1]} CV` : 'â€”';
};

const rows = [
  { id: 'fuente', label: 'Fuente' },
  { id: 'concesionario', label: 'Concesionario' },
  { id: 'marca', label: 'Marca/Modelo' },
  { id: 'motor', label: 'Motor / Cambio' },
  { id: 'potencia', label: 'Potencia (CV)' },
  { id: 'acabat', label: 'Acabado' },
  { id: 'color', label: 'Color' },
  { id: 'kms', label: 'KilÃ³metros' },
  { id: 'total', label: 'Total contado' },
  { id: 'iva', label: 'IVA' },
  { id: 'pvp', label: 'PVP' },
  { id: 'descuento', label: 'Descuento' },
  { id: 'base', label: 'Base' },
  { id: 'mat', label: 'MatriculaciÃ³n' },
  { id: 'otros', label: 'Otros' },
  { id: 'ciudad', label: 'Ciudad' },
  { id: 'mantenimiento', label: 'Mantenimiento / revisiones' },
  { id: 'enlace', label: 'Enlace anuncio' }
];
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard ofertas | Furgoneta</title>
  </head>
  <body>
    <header>
      <div>
        <h1>Dashboard de ofertas</h1>
      </div>
      <nav class="nav">
        <a href="/" class="active">Ofertas</a>
        <a href="/dealers">Concesionarios</a>
      </nav>
    </header>
    <section class="summary">
      <div class="chip">Ofertas: {total}</div>
      <div class="chip warn">Ocultas: {hiddenCount}</div>
      <button id="toggleHidden" class="chip-btn">Mostrar ocultas</button>
      <div class="drag-hint">Arrastra las columnas para reordenar (se guarda en el JSON).</div>
    </section>
    <main>
      <div class="table-wrap vertical">
        <table class="vertical-table">
          <thead>
            <tr>
              <th>Dato</th>
              {offers.map((offer) => {
                const logo = offer.brand?.logo;
                return (
                  <th data-offer-id={offer.id} class={`draggable ${offer.hidden ? 'hidden-offer hidden-collapse' : ''} ${offer.favorite ? 'favorite-offer' : ''}`} draggable="true">
                    <div class="cell-heading">
                      {logo && <img class="logo-inline" src={logo} alt="Logo" loading="lazy" />}
                      <div class="strong">{offer.modelo}</div>
                    </div>
                  </th>
                );
              })}
            </tr>
          </thead>
          <tbody>
            {rows.map((row) => (
              <tr>
                <th class="row-label">{row.label}</th>
                {offers.map((offer) => (
                  <td data-offer-id={offer.id} class={`cell ${offer.hidden ? 'hidden-offer hidden-collapse' : ''} ${offer.favorite ? 'favorite-offer' : ''} ${row.id === 'total' ? 'price total' : row.id === 'pvp' || row.id === 'descuento' || row.id === 'base' || row.id === 'iva' || row.id === 'mat' || row.id === 'otros' ? 'price' : ''}`}>
                    {row.id === 'marca' && (
                      <div>
                        <div class="strong">{offer.modelo}</div>
                        <div class="muted">{offer.dealer?.name || ''}</div>
                      </div>
                    )}
                    {row.id === 'motor' && (
                      <div>
                        <div class="strong">{offer.motorizacion}</div>
                        <div class="muted">{offer.cambio}</div>
                      </div>
                    )}
                    {row.id === 'potencia' && (
                      <div>{horsepower(offer)}</div>
                    )}
                    {row.id === 'acabat' && offer.acabatetapiceria}
                    {row.id === 'color' && (
                      <div>{offer.color || 'â€”'}</div>
                    )}
                    {row.id === 'kms' && (
                      <div>{offer.kms ?? 'â€”'}</div>
                    )}
                    {row.id === 'total' && euro(offer.total_contado)}
                    {row.id === 'pvp' && euro(offer.pvp)}
                    {row.id === 'descuento' && euro(offer.descuento)}
                    {row.id === 'base' && euro(offer.base_imponible)}
                    {row.id === 'iva' && euro(offer.iva)}
                    {row.id === 'mat' && euro(offer.matriculacion)}
                    {row.id === 'otros' && euro(offer.otros_costes)}
                    {row.id === 'concesionario' && (
                      <div>
                        <div>{offer.dealer?.name || 'â€”'}</div>
                      </div>
                    )}
                    {row.id === 'fuente' && (
                      <div>{offer.source?.name || 'â€”'}</div>
                    )}
                    {row.id === 'ciudad' && (
                      <div>
                        <div>{offer.dealer?.city || 'â€”'}</div>
                      </div>
                    )}
                    {row.id === 'mantenimiento' && (
                      <div>{offer.mantenimiento || 'â€”'}</div>
                    )}
                    {row.id === 'enlace' && (
                      <div>
                        {offer.enlace ? <a href={offer.enlace} target="_blank">Ver anuncio</a> : 'â€”'}
                      </div>
                    )}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </main>

    <script>
      (async () => {
        const res = await fetch('/api/hidden');
        const data = await res.json().catch(() => ({ hidden: [] }));
        const hidden = new Set(data.hidden || []);
        const resFav = await fetch('/api/favorites');
        const favData = await resFav.json().catch(() => []);
        const favorites = new Set(favData || []);
        const toggleBtn = document.getElementById('toggleHidden');
        let showHidden = false;

        const applyHidden = () => {
          document.querySelectorAll('[data-offer-id]').forEach((el) => {
            const id = el.getAttribute('data-offer-id');
            if (!id) return;
            if (hidden.has(id)) {
              el.classList.add('hidden-offer');
              el.classList.toggle('hidden-collapse', !showHidden);
            } else {
              el.classList.remove('hidden-offer', 'hidden-collapse');
            }
          });
          toggleBtn.textContent = showHidden ? 'Ocultar ocultas' : 'Mostrar ocultas';
        };

        document.querySelectorAll('th[data-offer-id]').forEach((th) => {
          const id = th.getAttribute('data-offer-id');
          if (!id) return;
          const actions = document.createElement('div');
          actions.className = 'actions-row';

          const btn = document.createElement('button');
          btn.className = 'hide-btn';
          const bin = document.createElement('span');
          bin.textContent = hidden.has(id) ? 'â†©ï¸' : 'ðŸ—‘ï¸';
          btn.appendChild(bin);
          btn.onclick = async () => {
            await fetch('/api/hidden', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ id, hidden: !hidden.has(id) })
            });
            location.reload();
          };
          actions.appendChild(btn);

          const favBtn = document.createElement('button');
          favBtn.className = 'fav-btn';
          const star = document.createElement('span');
          star.textContent = favorites.has(id) ? 'â˜…' : 'â˜†';
          favBtn.appendChild(star);
          favBtn.onclick = async () => {
            await fetch('/api/favorites', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ id, favorite: !favorites.has(id) })
            });
            location.reload();
          };
          actions.appendChild(favBtn);

          th.appendChild(actions);
        });

        toggleBtn.onclick = () => {
          showHidden = !showHidden;
          applyHidden();
        };

        applyHidden();

        // ReordenaciÃ³n por drag & drop
        let order = Array.from(document.querySelectorAll('th[data-offer-id]')).map((th) =>
          th.getAttribute('data-offer-id')
        );
        const applyOrder = () => {
          const rows = document.querySelectorAll('.vertical-table tr');
          rows.forEach((row) => {
            const firstCell = row.children[0];
            const cells = Array.from(row.children).slice(1);
            const map = new Map();
            cells.forEach((cell) => map.set(cell.getAttribute('data-offer-id'), cell));
            while (row.children.length > 1) row.removeChild(row.lastElementChild);
            order.forEach((id) => {
              const cell = map.get(id);
              if (cell) row.appendChild(cell);
            });
            if (firstCell) row.insertBefore(firstCell, row.firstChild);
          });
        };

        let dragId = null;
        document.querySelectorAll('th[data-offer-id]').forEach((th) => {
          th.addEventListener('dragstart', (e) => {
            dragId = th.getAttribute('data-offer-id');
            th.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
          });
          th.addEventListener('dragend', () => {
            dragId = null;
            th.classList.remove('dragging');
            document.querySelectorAll('.drop-target').forEach((el) => el.classList.remove('drop-target'));
          });
          th.addEventListener('dragover', (e) => {
            e.preventDefault();
            th.classList.add('drop-target');
          });
          th.addEventListener('dragleave', () => {
            th.classList.remove('drop-target');
          });
          th.addEventListener('drop', async (e) => {
            e.preventDefault();
            const targetId = th.getAttribute('data-offer-id');
            if (!dragId || !targetId || dragId === targetId) return;
            const next = order.filter((x) => x !== dragId);
            const targetIndex = next.indexOf(targetId);
            next.splice(targetIndex, 0, dragId);
            order = next;
            applyOrder();
            // Persist order to JSON
            await fetch('/api/order', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ order })
            });
          });
        });
      })();
    </script>
  </body>
</html>
