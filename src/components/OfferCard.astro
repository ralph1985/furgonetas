---
import type { AstroComponentFactory } from 'astro';

type Option = { nombre: string; precio: number };
type Contacto = { nombre?: string; telefono?: string; email?: string };

export interface Offer {
  id: string;
  fuente: string;
  concesionario: string;
  contacto?: Contacto;
  modelo: string;
  motorizacion: string;
  cambio: string;
  acabatetapiceria: string;
  color?: string;
  opciones?: Option[];
  pvp?: number;
  descuento?: number;
  base_imponible?: number;
  iva?: number;
  iem?: number | null;
  total_contado?: number | null;
  total_financiado?: number | null;
  matriculacion?: number | null;
  otros_costes?: number | null;
  kms?: number | null;
  entrega?: string;
  notas?: string;
  foto?: string;
  reviewStatus?: string;
}

export interface Props {
  offer: Offer;
}

const euro = (n: number | null | undefined) =>
  typeof n === 'number' ? n.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }) : '—';

const { offer } = Astro.props;
const optTotal = (offer.opciones || []).reduce((acc, o) => acc + (o.precio || 0), 0);
const modelText = `${offer.modelo || ''} ${offer.concesionario || ''}`.toLowerCase();
const brandClass = modelText.includes('citro') ? 'card-citroen' : modelText.includes('rifter') || modelText.includes('peugeot') ? 'card-rifter' : '';
const logoSrc = modelText.includes('citro')
  ? '/logos/citroen.svg'
  : modelText.includes('rifter') || modelText.includes('peugeot')
    ? '/logos/peugeot.svg'
    : modelText.includes('opel')
      ? '/logos/opel.png'
      : modelText.includes('toyota')
        ? '/logos/toyota.svg'
        : '';
---

<article class={`card ${brandClass}`}>
  <div class="top-row">
    <div class="meta">
      <span class="pill">{offer.modelo}</span>
      <span class="pill">{offer.motorizacion} · {offer.cambio}</span>
    </div>
    {logoSrc && (
      <div class="logo-row">
        <img src={logoSrc} alt="Logo" loading="lazy" />
      </div>
    )}
  </div>
  <h2>{offer.acabatetapiceria}</h2>
  <div class="meta">
    <span>{offer.color || 'Color por confirmar'}</span>
    <span>Km: {offer.kms ?? '—'}</span>
    <span>Entrega: {offer.entrega || '—'}</span>
  </div>

  <p class="section-title">Precios</p>
  <div class="table">
    <div class="row">
      <span>Total contado</span><strong class="highlight-total">{euro(offer.total_contado)}</strong>
    </div>
    <div class="row">
      <span>PVP</span><strong>{euro(offer.pvp)}</strong>
    </div>
    <div class="row">
      <span>Descuento</span><strong>{euro(offer.descuento)}</strong>
    </div>
    <div class="row">
      <span>Base imponible</span><strong>{euro(offer.base_imponible)}</strong>
    </div>
    <div class="row">
      <span>IVA</span><strong>{euro(offer.iva)}</strong>
    </div>
    <div class="row">
      <span>Matriculación</span><strong>{euro(offer.matriculacion)}</strong>
    </div>
    <div class="row">
      <span>IEM</span><strong>{euro(offer.iem ?? 0)}</strong>
    </div>
    <div class="row">
      <span>Otros costes</span><strong>{euro(offer.otros_costes)}</strong>
    </div>
  </div>

  <p class="section-title">Opciones (total {euro(optTotal)})</p>
  <ul>
    {(offer.opciones || []).map((o) => (
      <li>{o.nombre}: <strong>{euro(o.precio)}</strong></li>
    ))}
    {(offer.opciones || []).length === 0 && <li>Sin opciones</li>}
  </ul>

  <p class="section-title">Contacto</p>
  <div class="meta">
    <span>{offer.fuente}</span>
    <span>{offer.concesionario}</span>
    {offer.contacto?.nombre && <span>{offer.contacto.nombre}</span>}
    {offer.contacto?.telefono && <span>{offer.contacto.telefono}</span>}
    {offer.contacto?.email && (
      <span><a href={`mailto:${offer.contacto.email}`}>{offer.contacto.email}</a></span>
    )}
  </div>

  <p class="note">Notas: {offer.notas || '—'}</p>
</article>
